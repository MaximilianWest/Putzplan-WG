<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wohnung Putzplan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .extra-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .kw-label {
      font-size: 20px;
      font-weight: bold;
    }
    .arrow, .ctrl-btn {
      cursor: pointer;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      background: #2196f3;
      color: white;
      transition: background 0.2s;
    }
    .arrow:hover, .ctrl-btn:hover {
      background: #1976d2;
    }
    .task {
      background: white;
      padding: 20px;
      margin: 15px auto;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 300px;
      text-align: center;
      transition: background 0.3s;
    }
    .task.done {
      background: #c8e6c9;
    }
    button {
      margin-top: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #2196f3;
      color: white;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      max-width: 250px;
    }
    button:hover {
      background: #1976d2;
    }
  </style>
</head>
<body>
  <h1>ðŸ§¹ Putzplan fÃ¼r die WG</h1>

  <div class="controls">
    <button class="arrow" id="prev">â—€</button>
    <span class="kw-label" id="kw"></span>
    <button class="arrow" id="next">â–¶</button>
  </div>

  <div class="extra-controls">
    <button class="ctrl-btn" id="today">Zur aktuellen KW</button>
    <button class="ctrl-btn" id="export">Als PDF exportieren</button>
  </div>

  <div id="plan"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8FXE7QrKU5ExoIQjphfgRRggoCVlwed0",
      authDomain: "putzplan-wg.firebaseapp.com",
      projectId: "putzplan-wg",
      storageBucket: "putzplan-wg.firebasestorage.app",
      messagingSenderId: "190775803053",
      appId: "1:190775803053:web:c76840da3ad7df763d1a24",
      measurementId: "G-F93DGZ77ZL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const mitbewohner = ["Max", "Karol", "Louis", "Andreas"];
    const aufgaben = ["Bad Putzen", "KÃ¼che Putzen"];

    Date.prototype.getWeekNumber = function() {
      const d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    };

    const thisWeek = new Date().getWeekNumber();
    let currentWeek = thisWeek;

    function getAssignments(week) {
      const startIndex = week % mitbewohner.length;
      let available = [...mitbewohner];
      let result = [];
      aufgaben.forEach((aufgabe, i) => {
        const index = (startIndex + i) % available.length;
        const person = available[index];
        result.push({ aufgabe, person });
        available.splice(index, 1);
      });
      return result;
    }

    async function markTaskDone(week, aufgabe) {
      const taskDoc = doc(db, "tasks", `week_${week}`);
      await setDoc(taskDoc, { [aufgabe]: true }, { merge: true });
    }

    async function getTaskStatus(week) {
      const taskDoc = doc(db, "tasks", `week_${week}`);
      const docSnap = await getDoc(taskDoc);
      return docSnap.exists() ? docSnap.data() : {};
    }

    async function renderPlan(week) {
      document.getElementById("kw").textContent = "Kalenderwoche (KW) " + week;
      const assignments = getAssignments(week);
      const container = document.getElementById("plan");
      container.innerHTML = "";

      const status = await getTaskStatus(week);

      assignments.forEach(({aufgabe, person}) => {
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `<h2>${aufgabe}</h2><p><strong>${person}</strong></p>`;

        if(status[aufgabe]) div.classList.add("done");

        const button = document.createElement("button");
        button.textContent = "Aufgabe abgeschlossen";
        button.onclick = async () => {
          div.classList.add("done");
          await markTaskDone(week, aufgabe);
        };

        div.appendChild(button);
        container.appendChild(div);
      });
    }

    document.getElementById("prev").onclick = () => {
      currentWeek--;
      if (currentWeek < 1) currentWeek = 52;
      renderPlan(currentWeek);
    };

    document.getElementById("next").onclick = () => {
      currentWeek++;
      if (currentWeek > 52) currentWeek = 1;
      renderPlan(currentWeek);
    };

    document.getElementById("today").onclick = () => {
      currentWeek = thisWeek;
      renderPlan(currentWeek);
    };

    document.getElementById("export").onclick = async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text("Putzplan fÃ¼r die WG", 20, y);
      y += 10;

      for (let w = thisWeek; w <= 52; w++) {
        doc.setFontSize(14);
        doc.text(`Kalenderwoche ${w}`, 20, y);
        y += 8;

        const assignments = getAssignments(w);
        const status = await getTaskStatus(w);
        assignments.forEach(({aufgabe, person}) => {
          const done = status[aufgabe] ? "âœ” erledigt" : "âœ˜ offen";
          doc.setFontSize(12);
          doc.text(`- ${aufgabe}: ${person} [${done}]`, 25, y);
          y += 6;
        });

        y += 4;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      }
      doc.save("Putzplan.pdf");
    };

    renderPlan(currentWeek);
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
